<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chat Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
            body {
                font-size: 14px;
                line-height: 1.5;
                margin: 0;
                padding: 0;
                background-color: var(--bg-color, #000);
                color: var(--text-color, #00ff00);
                overflow: hidden;
                display: flex;
                flex-direction: row;
            }
            
            @media (max-width: 768px) {
            body {
                flex-direction: column;
                font-size: 16px;
                overflow: auto;
                display: flex;
            }
            }
        .sidebar {
            width: 250px;
            border-right: 2px solid #00ff00;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 90%;
            padding: 8px;
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Press Start 2P', monospace;
        }
        .user-list {
            flex: 1;
            overflow-y: auto;
        }
        .user-section {
            margin-bottom: 20px;
        }
        .user-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
        }
        .user {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #00ff00;
        }
        .user:hover {
            background-color: #111;
        }
        .main-chat {
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 5px 10px;
            padding-bottom: 0;
            border-right: 2px solid #00ff00;
            overflow-x: hidden;
            flex: 1;
            height: calc(100vh - 50px);
        }
        .chat-title {
            font-size: 18px;
            margin-bottom: 5px;
        }
        .back-button {
            margin-bottom: 5px;
        }
        body > .main-chat > .messages {
            flex: 1;
            border: 1px solid #00ff00;
            border-bottom: none;
            padding: 5px 10px 490px 10px;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #000;
            margin-bottom: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 0;
            box-sizing: border-box;
        }
        .message {
            font-family: 'Press Start 2P', monospace;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            max-width: 80%;
            width: fit-content;
            box-sizing: border-box;
            background-color: var(--accent-color, #00ff00);
            color: var(--bg-color, #000);
            border: 1px solid var(--accent-color, #00ff00);
            border-radius: 10px;
            padding: 10px;
            position: relative;
        }


        .message strong {
            color: #33ff33;
        }
        .message small {
            font-size: 0.7em;
        }
        .file-link {
            color: #ffff00;
            font-weight: bold;
        }
        .status-message {
            background: none;
            border: none;
            padding: 5px 10px;
            font-style: italic;
            color: var(--accent-color, #00ff00);
            text-align: center;
        }
        .input-area {
            display: flex;
            align-items: center;
            border-top: 1px solid #00ff00;
            padding: 3px 10px;
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 10px;
            background-color: #000;
            height: 50px;
            margin: 0;
        }
        .input-area input[type="text"] {
            flex: 1;
            padding: 6px;
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Press Start 2P', monospace;
            min-width: 0;
            height: 35px;
        }
        .input-area input[type="file"] {
            margin-left: 10px;
            color: #000;
            background-color: #00ff00;
            border: 1px solid #00ff00;
            font-family: 'Press Start 2P', monospace;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            height: 35px;
        }
        .input-area input[type="file"]:hover {
            background-color: #33ff33;
        }
        .input-area button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 8px;
            height: 35px;
        }
        .input-area button:hover {
            background-color: #33ff33;
        }
        .back-button {
            display: none;
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            text-transform: uppercase;
            z-index: 10;
        }
        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            z-index: 10;
        }
        .online-count {
            position: absolute;
            top: 30px;
            right: 10px;
            font-size: 12px;
            z-index: 10;
        }
        .logout-button {
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            text-transform: uppercase;
            z-index: 10;
        }
        .logout-button:hover {
            background-color: #33ff33;
        }
        .admin-button {
            position: absolute;
            top: 100px;
            right: 10px;
            background-color: #ff0000;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            text-transform: uppercase;
            z-index: 10;
        }
        .admin-button:hover {
            background-color: #ff6666;
        }
        .settings-button {
            position: absolute;
            top: 140px;
            right: 10px;
            background-color: #ffaa00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            text-transform: uppercase;
            z-index: 10;
        }
        .settings-button:hover {
            background-color: #ffcc66;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                font-size: 16px;
                min-height: 100vh;
                overflow: hidden;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid var(--accent-color, #00ff00);
                max-height: 150px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .search-bar {
                margin-bottom: 10px;
                position: sticky;
                top: 0;
                background: var(--bg-color, #000);
                padding: 10px 0;
                z-index: 10;
            }
            
            .search-bar input {
                font-size: 16px;
                padding: 15px;
                width: 100%;
                color: var(--text-color, #00ff00);
                border-color: var(--accent-color, #00ff00);
                background-color: var(--bg-color, #000);
                border-radius: 8px;
                min-height: 44px;
            }
            
            .user-list {
                max-height: 200px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #search {
                display: none;
            }
            
            .user {
                padding: 15px 12px;
                font-size: 16px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
                color: var(--text-color, #00ff00);
                min-height: 44px;
                display: flex;
                align-items: center;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .user:active {
                background-color: var(--accent-color, #00ff00);
                color: var(--bg-color, #000);
            }
            
            .user-section h3 {
                font-size: 16px;
                margin: 5px 0;
                color: var(--text-color, #00ff00);
                position: sticky;
                top: 0;
                background: var(--bg-color, #000);
                padding: 10px 0;
                z-index: 5;
            }
            
            .main-chat {
                border-right: none;
                padding: 10px;
                position: relative;
                display: flex;
                flex-direction: column;
                flex: 1;
            }
            
            .user-info {
                position: static;
                font-size: 16px;
                margin-bottom: 5px;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .online-count {
                position: static;
                font-size: 14px;
                margin-bottom: 10px;
                padding: 0 10px;
            }
            
            .logout-button, .admin-button, .settings-button {
                position: static;
                display: block;
                width: 100%;
                margin: 5px 0;
                padding: 18px;
                font-size: 16px;
                font-weight: bold;
                min-height: 50px;
                border-radius: 8px;
            }
            
            .back-button {
                position: static;
                width: 100%;
                margin: 10px 0;
                padding: 18px;
                font-size: 16px;
                min-height: 50px;
                border-radius: 8px;
            }
            
            .chat-title {
                font-size: 20px;
                margin: 15px 0;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .messages {
                max-height: 50vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 16px;
                line-height: 1.5;
                margin-bottom: 0;
                padding: 10px;
                border: 1px solid var(--accent-color, #00ff00);
                border-radius: 8px;
            }
            
            .message {
                font-family: 'Press Start 2P', monospace;
                text-shadow: 0 0 5px var(--bg-color, #000);
                margin-bottom: 15px;
                padding: 12px;
                font-size: 16px;
                border-radius: 8px;
                background: var(--accent-color, #00ff00);
                color: var(--bg-color, #000);
                border: 1px solid var(--accent-color, #00ff00);
            }
            
            .file-link {
                color: #ffff00;
                font-weight: bold;
            }
            
            .input-area {
                padding: 15px;
                background: var(--bg-color, #000);
                border-top: 2px solid var(--accent-color, #00ff00);
            }
            
            .input-area input[type="text"] {
                font-size: 16px;
                padding: 9px;
                margin-right: 10px;
                flex: 1;
                color: var(--text-color, #00ff00);
                border-color: var(--accent-color, #00ff00);
                background-color: var(--bg-color, #000);
                border-radius: 8px;
                min-height: 25px;
            }
            
            .input-area #file-button {
                width: 40px;
                margin-right: 10px;
                padding: 5px;
                min-height: 25px;
                font-size: 16px;
            }
            
            .input-area #send-button {
                width: 40px;
                padding: 5px;
                min-height: 25px;
                font-size: 16px;
            }
            
            #menu-button {
                width: 60px;
                height: 60px;
                font-size: 24px;
                padding: 0;
                text-align: center;
                line-height: 60px;
                z-index: 1000;
            }
            
            #menu-options {
                display: flex;
                flex-direction: column;
                gap: 5px;
                z-index: 1000;
            }
            
            .input-area button {
                padding: 5px 8px;
                font-size: 16px;
                font-weight: bold;
                margin: 0;
                min-height: 25px;
                min-width: 40px;
                border-radius: 8px;
            }
            
            .input-area #file-button {
                width: 40px;
                margin-right: 10px;
                padding: 5px;
                min-height: 25px;
                font-size: 16px;
            }
            
            .user-info {
                position: static;
                font-size: 16px;
                margin-bottom: 5px;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .online-count {
                position: static;
                font-size: 14px;
                margin-bottom: 10px;
                padding: 0 10px;
            }
            
            .logout-button, .admin-button, .settings-button {
                position: static;
                display: block;
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                font-size: 16px;
                font-weight: bold;
            }
            
            .back-button {
                position: static;
                width: 100%;
                margin: 10px 0;
                padding: 15px;
                font-size: 16px;
            }
            
            .chat-title {
                font-size: 20px;
                margin: 15px 0;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .messages {
                margin-bottom: 0;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .message {
                margin-bottom: 15px;
                padding: 10px;
                font-size: 16px;
            }
            
            .message {
                margin-bottom: 15px;
                padding: 10px;
                font-size: 16px;
            }
            
            .input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 15px;
                background: var(--bg-color, #000);
                border-top: 2px solid var(--accent-color, #00ff00);
                z-index: 100;
            }

            
            /* Touch-friendly spacing */
            .user, button, input {
                min-height: 44px;
            }
            
            /* Ensure readability and touch targets */
            body, .message, input, button {
                font-size: 16px;
            }
            
            /* Smooth scrolling for mobile */
            * {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Prevent zoom on input focus */
            input[type="text"], input[type="password"], input[type="file"], textarea {
                font-size: 16px;
                transform: scale(1);
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                max-height: 120px;
            }
            
            .main-chat {
                flex: 1;
            }
            
            .messages {
                margin-bottom: 0;
                padding: 8px;
            }
            
            .input-area {
                padding: 12px;
            }
            
            .input-area input[type="text"] {
                font-size: 16px;
                padding: 15px;
            }
            
            .input-area button {
                padding: 15px 20px;
                font-size: 16px;
                min-width: 80px;
            }
        }
        
        @media (max-height: 600px) {
            .messages {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
        <div class="sidebar">
        <div class="user-list">
            <input type="text" id="search" placeholder="SEARCH USERS">
            <div class="user-section">
                <h3>ONLINE</h3>
                <div id="online-users"></div>
            </div>
            <div class="user-section">
                <h3>OFFLINE</h3>
                <div id="offline-users"></div>
            </div>
        </div>
    </div>
    <div class="main-chat">
        <div class="user-info" id="user-info">LOGGED IN AS: </div>
        <div class="online-count" id="online-count">USERS ONLINE: 0</div>
        <button id="menu-button" style="position: fixed; top: 50px; right: 10px;">â˜°</button>
        <div id="menu-options" style="display: none; position: fixed; top: 115px; right: 10px; padding: 10px;">
            <button class="logout-button" id="logout-button">LOGOUT</button>
            <button class="admin-button" id="admin-button" style="display: none;">ADMIN</button>
            <button class="settings-button" id="settings-button">SETTINGS</button>
        </div>
        <h2 class="chat-title" id="chat-title">PUBLIC CHAT</h2>
        <button class="back-button" id="back-button">BACK TO PUBLIC</button>
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="ENTER MESSAGE">
            <input type="file" id="file-input" style="display: none;">
            <button id="file-button">ðŸ“Ž</button>
            <button id="send-button">âž¤</button>
        </div>
    </div>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        let currentChat = 'public'; // 'public' or username for private
        let allUsers = [];
        let onlineUsers = [];

        document.getElementById('user-info').textContent = 'LOGGED IN AS: ' + username.toUpperCase();
        
        // Load and apply theme
        function applyTheme(theme) {
            const root = document.documentElement;
            root.style.setProperty('--text-color', theme.textColor);
            root.style.setProperty('--bg-color', theme.bgColor);
            root.style.setProperty('--accent-color', theme.accentColor);
            
            // Apply theme to existing elements
            document.body.style.backgroundColor = theme.bgColor;
            document.body.style.color = theme.textColor;
            
            // Update all elements with color styles
            const elementsToUpdate = [
                { selector: 'input[type="text"], input[type="file"]', property: 'color', value: theme.textColor },
                { selector: 'input[type="text"], input[type="file"]', property: 'borderColor', value: theme.accentColor },
                { selector: 'input[type="text"], input[type="file"]', property: 'backgroundColor', value: theme.bgColor },
                { selector: 'button', property: 'backgroundColor', value: theme.accentColor },
                { selector: 'button', property: 'color', value: theme.bgColor },
                { selector: '.sidebar', property: 'borderColor', value: theme.accentColor },
                { selector: '.main-chat', property: 'borderColor', value: theme.accentColor },
                { selector: '.messages', property: 'borderColor', value: theme.accentColor },
                { selector: '.input-area', property: 'borderColor', value: theme.accentColor },
                { selector: '.user-info', property: 'color', value: theme.textColor },
                { selector: '.online-count', property: 'color', value: theme.textColor },
                { selector: '.chat-title', property: 'color', value: theme.textColor },
                { selector: '.message', property: 'color', value: theme.textColor },
                { selector: '.message strong', property: 'color', value: theme.accentColor },
                { selector: '.user', property: 'color', value: theme.textColor },
                { selector: '.user', property: 'borderColor', value: theme.accentColor },
                { selector: '.user-section h3', property: 'color', value: theme.textColor },
                { selector: '.search-bar input', property: 'color', value: theme.textColor },
                { selector: '.search-bar input', property: 'borderColor', value: theme.accentColor },
                { selector: '.search-bar input', property: 'backgroundColor', value: theme.bgColor },
                { selector: '.file-link', property: 'color', value: theme.accentColor }
            ];
            
            elementsToUpdate.forEach(({ selector, property, value }) => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => el.style[property] = value);
            });
            
            // Also update dynamically created user elements
            const userElements = document.querySelectorAll('.user');
            userElements.forEach(el => {
                el.style.color = theme.textColor;
                el.style.borderColor = theme.accentColor;
            });
            
            const userHeaders = document.querySelectorAll('.user-section h3');
            userHeaders.forEach(el => {
                el.style.color = theme.textColor;
            });
            
            // Also update file links
            const fileLinks = document.querySelectorAll('.file-link');
            fileLinks.forEach(el => {
                el.style.color = theme.accentColor;
            });
            
            // Update text shadows
            const elementsWithShadow = document.querySelectorAll('.user-info, .online-count, .chat-title, .user-section h3');
            elementsWithShadow.forEach(el => {
                el.style.textShadow = `0 0 5px ${theme.accentColor}`;
            });
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem(`theme_${username}`);
        if (savedTheme) {
            const theme = JSON.parse(savedTheme);
            applyTheme(theme);
        }
        
        if (username === 'admin') {
            document.getElementById('admin-button').style.display = 'block';
        }

        socket.emit('join', { username });

        loadMessages();

        fetch('/users')
            .then(res => res.json())
            .then(users => {
                allUsers = users;
                updateUserLists();
            });

        socket.on('online_users', (users) => {
            onlineUsers = users;
            updateUserLists();
            updateOnlineCount();
        });

        socket.on('user_online', (user) => {
            if (!onlineUsers.includes(user)) {
                onlineUsers.push(user);
                updateUserLists();
                updateOnlineCount();
                if (currentChat === 'public') {
                    addMessage(user + ' has joined the chat.');
                }
            }
        });

        socket.on('user_offline', (user) => {
            onlineUsers = onlineUsers.filter(u => u !== user);
            updateUserLists();
            updateOnlineCount();
            if (currentChat === 'public') {
                addMessage(user + ' has left the chat.');
            }
        });

        socket.on('public_message', (data) => {
            if (currentChat === 'public') {
                addMessage(data.from + ' <small>[' + new Date(data.timestamp || Date.now()).toLocaleTimeString() + ']</small>: ' + data.message);
            }
        });

        socket.on('private_message', (data) => {
            if (currentChat === data.from || currentChat === data.to) {
                addMessage(data.from + ' <small>[' + new Date(data.timestamp || Date.now()).toLocaleTimeString() + ']</small>: ' + data.message);
            }
        });

        function updateUserLists() {
            const search = document.getElementById('search').value.toLowerCase();
            const onlineFiltered = onlineUsers.filter(u => u.toLowerCase().includes(search) && u !== username);
            const offlineFiltered = allUsers.filter(u => !onlineUsers.includes(u) && u !== username && u.toLowerCase().includes(search));

            document.getElementById('online-users').innerHTML = onlineFiltered.map(u => `<div class="user" onclick="switchToPrivate('${u}')">${u}</div>`).join('');
            document.getElementById('offline-users').innerHTML = offlineFiltered.map(u => `<div class="user" onclick="switchToPrivate('${u}')">${u}</div>`).join('');
            
            // Reapply theme to newly created user list elements
            const savedTheme = localStorage.getItem(`theme_${username}`);
            if (savedTheme) {
                const theme = JSON.parse(savedTheme);
                applyTheme(theme);
            }
        }
        
        function updateOnlineCount() {
            document.getElementById('online-count').textContent = `USERS ONLINE: ${onlineUsers.length}`;
        }

        function switchToPrivate(user) {
            currentChat = user;
            document.getElementById('chat-title').textContent = `PRIVATE WITH ${user.toUpperCase()}`;
            document.getElementById('back-button').style.display = 'block';
            document.getElementById('messages').innerHTML = '';
            loadMessages();
        }

        function switchToPublic() {
            currentChat = 'public';
            document.getElementById('chat-title').textContent = 'PUBLIC CHAT';
            document.getElementById('back-button').style.display = 'none';
            document.getElementById('messages').innerHTML = '';
            loadMessages();
        }

        function addMessage(msg, setScroll) {
            if (typeof setScroll === 'undefined') setScroll = true;
            var div = document.createElement('div');
            if (msg.indexOf('has joined') !== -1 || msg.indexOf('has left') !== -1) {
                div.className = 'status-message';
            } else {
                div.className = 'message';
            }
            var processedMsg = msg;
            var parts = msg.split(' ');
            for (var urlIndex = 0; urlIndex < parts.length; urlIndex++) {
                var url = parts[urlIndex];
                if (url.match(/^https?:\/\/|^\//)) {
                    var filename = url.split('/').pop();
                    var ext = filename.split('.').pop().toLowerCase();
                    var imgTags = ['jpg', 'jpeg', 'png', 'gif'];
                    if (imgTags.includes(ext)) {
                        processedMsg = processedMsg.replace(url, "<img src='" + url + "' style='max-width: 200px; max-height: 200px;'><br><a href='" + url + "' download='" + filename + "' class='file-link'>Download " + filename + "</a>");
                    } else {
                        processedMsg = processedMsg.replace(url, "<a href='" + url + "' download='" + filename + "' class='file-link'>" + filename + "</a>");
                    }
                }
            }
            div.innerHTML = processedMsg;
            document.getElementById('messages').appendChild(div);
            if (setScroll) {
                const messagesEl = document.getElementById('messages');
                const style = window.getComputedStyle(messagesEl);
                const paddingBottom = parseInt(style.paddingBottom) || 0;
                messagesEl.scrollTop = messagesEl.scrollHeight - messagesEl.clientHeight - paddingBottom;
            }
        }

        document.getElementById('search').addEventListener('input', updateUserLists);

        document.getElementById('back-button').addEventListener('click', switchToPublic);

        document.getElementById('send-button').addEventListener('click', async () => {
            const msg = document.getElementById('message-input').value.trim();
            const fileInput = document.getElementById('file-input');
            let message = msg;
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.url) {
                        message += (msg ? ' ' : '') + data.url;
                    }
                } catch (error) {
                    alert('Upload failed: ' + error.message);
                    return;
                }
                fileInput.value = '';
            }
            if (message) {
                socket.emit('send_message', { username, message, to: currentChat === 'public' ? null : currentChat });
                addMessage(username + ' <small>[' + new Date().toLocaleTimeString() + ']</small>: ' + message);
                document.getElementById('message-input').value = '';
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });

        function loadMessages() {
            const params = new URLSearchParams();
            params.append('username', username);
            if (currentChat !== 'public') {
                params.append('to', currentChat);
            }
            fetch('/messages?' + params)
                .then(res => res.json())
                .then(msgs => {
                     msgs.forEach(msg => {
                         let displayMsg;
                         if (msg.from === 'System' && (msg.message.includes('has joined') || msg.message.includes('has left'))) {
                             displayMsg = msg.message;
                         } else {
                             displayMsg = msg.from + ' <small>[' + new Date(msg.timestamp).toLocaleTimeString() + ']</small>: ' + msg.message;
                         }
                         addMessage(displayMsg, false);
                     });
                     const messagesEl = document.getElementById('messages');
                     const style = window.getComputedStyle(messagesEl);
                     const paddingBottom = parseInt(style.paddingBottom) || 0;
                     messagesEl.scrollTop = messagesEl.scrollHeight - messagesEl.clientHeight - paddingBottom;
                 });
        }

        document.getElementById('menu-button').addEventListener('click', () => {
            const menu = document.getElementById('menu-options');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });
        
        document.getElementById('menu-button').addEventListener('touchstart', () => {
            const menu = document.getElementById('menu-options');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('file-button').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            socket.emit('leave', { username });
            setTimeout(() => window.location.href = '/', 100);
        });

        document.getElementById('admin-button').addEventListener('click', () => {
            window.location.href = `/admin.html?username=${username}`;
        });

        document.getElementById('settings-button').addEventListener('click', () => {
            window.location.href = `/settings.html?username=${username}`;
        });
    </script>
</body>
</html>