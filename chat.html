<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Terminal</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #00ff00;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            background-image: radial-gradient(circle, #111 0%, #000 100%);
        }
        .sidebar {
            width: 250px;
            border-right: 2px solid #00ff00;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 90%;
            padding: 8px;
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        .user-list {
            flex: 1;
            overflow-y: auto;
        }
        .user-section {
            margin-bottom: 20px;
        }
        .user-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #00ff00;
        }
        .user {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #00ff00;
        }
        .user:hover {
            background-color: #111;
        }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 2px solid #00ff00;
            overflow-x: hidden;
        }
        .chat-title {
            font-size: 18px;
            text-shadow: 0 0 5px #00ff00;
            margin-bottom: 10px;
        }
        .messages {
            height: calc(100vh - 200px);
            border: 1px solid #00ff00;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #000;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .message {
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            box-sizing: border-box;
        }
        .message strong {
            color: #33ff33;
        }
        .input-area {
            display: flex;
            margin-top: 10px;
            align-items: center;
            border-top: 1px solid #00ff00;
            padding-top: 10px;
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 10px;
            background-color: #000;
        }
        .input-area input[type="text"] {
            flex: 1;
            padding: 8px;
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-width: 0;
        }
        .input-area input[type="file"] {
            margin-left: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        .input-area button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        .input-area button:hover {
            background-color: #33ff33;
        }
        .back-button {
            display: none;
            margin-bottom: 10px;
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }
        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            text-shadow: 0 0 5px #00ff00;
        }
        .logout-button {
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-transform: uppercase;
        }
        .logout-button:hover {
            background-color: #33ff33;
        }
        .admin-button {
            position: absolute;
            top: 100px;
            right: 10px;
            background-color: #ff0000;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-transform: uppercase;
        }
        .admin-button:hover {
            background-color: #ff6666;
        }
        .settings-button {
            position: absolute;
            top: 140px;
            right: 10px;
            background-color: #ffaa00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            text-transform: uppercase;
        }
        .settings-button:hover {
            background-color: #ffcc66;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                font-size: 16px;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid var(--accent-color, #00ff00);
                max-height: 150px;
            }
            
            .search-bar {
                margin-bottom: 10px;
            }
            
            .search-bar input {
                font-size: 16px;
                padding: 12px;
                width: 100%;
            }
            
            .user-list {
                max-height: 100px;
            }
            
            .user {
                padding: 8px 12px;
                font-size: 16px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .user-section h3 {
                font-size: 16px;
                margin: 5px 0;
            }
            
            .main-chat {
                border-right: none;
                padding: 10px;
                position: relative;
            }
            
            .user-info {
                position: static;
                font-size: 16px;
                margin-bottom: 10px;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .logout-button, .admin-button, .settings-button {
                position: static;
                display: block;
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                font-size: 16px;
                font-weight: bold;
            }
            
            .back-button {
                position: static;
                width: 100%;
                margin: 10px 0;
                padding: 15px;
                font-size: 16px;
            }
            
            .chat-title {
                font-size: 20px;
                margin: 15px 0;
                padding: 10px;
                border-bottom: 1px solid var(--accent-color, #00ff00);
            }
            
            .messages {
                height: calc(100vh - 320px);
                margin-bottom: 80px;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .message {
                margin-bottom: 15px;
                padding: 10px;
                font-size: 16px;
            }
            
            .input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 15px;
                background: var(--bg-color, #000);
                border-top: 2px solid var(--accent-color, #00ff00);
            }
            
            .input-area input[type="text"] {
                font-size: 16px;
                padding: 12px;
                margin-right: 10px;
                flex: 1;
            }
            
            .input-area input[type="file"] {
                margin-right: 10px;
                margin-bottom: 0;
            }
            
            .input-area button {
                padding: 12px 20px;
                font-size: 16px;
                font-weight: bold;
                margin: 0;
            }
            
            /* Touch-friendly spacing */
            .user, button, input {
                min-height: 44px;
            }
            
            /* Ensure readability */
            body, .message, input, button {
                min-font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                max-height: 120px;
            }
            
            .messages {
                height: calc(100vh - 280px);
            }
            
            .input-area {
                padding: 10px;
            }
            
            .input-area input[type="text"] {
                font-size: 14px;
                padding: 10px;
            }
            
            .input-area button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="search-bar">
            <input type="text" id="search" placeholder="SEARCH USERS">
        </div>
        <div class="user-list">
            <div class="user-section">
                <h3>ONLINE</h3>
                <div id="online-users"></div>
            </div>
            <div class="user-section">
                <h3>OFFLINE</h3>
                <div id="offline-users"></div>
            </div>
        </div>
    </div>
    <div class="main-chat">
        <div class="user-info" id="user-info">LOGGED IN AS: </div>
        <button class="logout-button" id="logout-button">LOGOUT</button>
        <button class="admin-button" id="admin-button" style="display: none;">ADMIN</button>
        <button class="settings-button" id="settings-button">SETTINGS</button>
        <h2 class="chat-title" id="chat-title">PUBLIC CHAT</h2>
        <button class="back-button" id="back-button">BACK TO PUBLIC</button>
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="ENTER MESSAGE">
            <input type="file" id="file-input">
            <button id="send-button">SEND</button>
        </div>
    </div>
    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        let currentChat = 'public'; // 'public' or username for private
        let allUsers = [];
        let onlineUsers = [];

        document.getElementById('user-info').textContent = 'LOGGED IN AS: ' + username.toUpperCase();
        
        // Load and apply theme
        function applyTheme(theme) {
            const root = document.documentElement;
            root.style.setProperty('--text-color', theme.textColor);
            root.style.setProperty('--bg-color', theme.bgColor);
            root.style.setProperty('--accent-color', theme.accentColor);
            
            // Apply theme to existing elements
            document.body.style.backgroundColor = theme.bgColor;
            document.body.style.color = theme.textColor;
            
            // Update all elements with color styles
            const elementsToUpdate = [
                { selector: 'input[type="text"], input[type="file"]', property: 'color', value: theme.textColor },
                { selector: 'input[type="text"], input[type="file"]', property: 'borderColor', value: theme.accentColor },
                { selector: 'input[type="text"], input[type="file"]', property: 'backgroundColor', value: theme.bgColor },
                { selector: 'button', property: 'backgroundColor', value: theme.accentColor },
                { selector: 'button', property: 'color', value: theme.bgColor },
                { selector: '.sidebar', property: 'borderColor', value: theme.accentColor },
                { selector: '.main-chat', property: 'borderColor', value: theme.accentColor },
                { selector: '.messages', property: 'borderColor', value: theme.accentColor },
                { selector: '.input-area', property: 'borderColor', value: theme.accentColor },
                { selector: '.user-info', property: 'color', value: theme.textColor },
                { selector: '.chat-title', property: 'color', value: theme.textColor },
                { selector: '.message', property: 'color', value: theme.textColor },
                { selector: '.message strong', property: 'color', value: theme.accentColor }
            ];
            
            elementsToUpdate.forEach(({ selector, property, value }) => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => el.style[property] = value);
            });
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem(`theme_${username}`);
        if (savedTheme) {
            const theme = JSON.parse(savedTheme);
            applyTheme(theme);
        }
        
        if (username === 'admin') {
            document.getElementById('admin-button').style.display = 'block';
        }

        socket.emit('join', { username });

        loadMessages();

        fetch('/users')
            .then(res => res.json())
            .then(users => {
                allUsers = users;
                updateUserLists();
            });

        socket.on('online_users', (users) => {
            onlineUsers = users;
            updateUserLists();
        });

        socket.on('user_online', (user) => {
            if (!onlineUsers.includes(user)) {
                onlineUsers.push(user);
                updateUserLists();
            }
        });

        socket.on('user_offline', (user) => {
            onlineUsers = onlineUsers.filter(u => u !== user);
            updateUserLists();
        });

        socket.on('public_message', (data) => {
            if (currentChat === 'public') {
                addMessage(`${data.from}: ${data.message}`);
            }
        });

        socket.on('private_message', (data) => {
            if (currentChat === data.from || currentChat === data.to) {
                addMessage(`${data.from}: ${data.message}`);
            }
        });

        function updateUserLists() {
            const search = document.getElementById('search').value.toLowerCase();
            const onlineFiltered = onlineUsers.filter(u => u.toLowerCase().includes(search) && u !== username);
            const offlineFiltered = allUsers.filter(u => !onlineUsers.includes(u) && u !== username && u.toLowerCase().includes(search));

            document.getElementById('online-users').innerHTML = onlineFiltered.map(u => `<div class="user" onclick="switchToPrivate('${u}')">${u}</div>`).join('');
            document.getElementById('offline-users').innerHTML = offlineFiltered.map(u => `<div class="user" onclick="switchToPrivate('${u}')">${u}</div>`).join('');
        }

        function switchToPrivate(user) {
            currentChat = user;
            document.getElementById('chat-title').textContent = `PRIVATE WITH ${user.toUpperCase()}`;
            document.getElementById('back-button').style.display = 'block';
            document.getElementById('messages').innerHTML = '';
            loadMessages();
        }

        function switchToPublic() {
            currentChat = 'public';
            document.getElementById('chat-title').textContent = 'PUBLIC CHAT';
            document.getElementById('back-button').style.display = 'none';
            document.getElementById('messages').innerHTML = '';
            loadMessages();
        }

        function addMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message';
            if (msg.includes('/uploads/')) {
                const parts = msg.split(' ');
                const urlIndex = parts.findIndex(p => p.startsWith('/uploads/'));
                const url = parts[urlIndex];
                const filename = url.split('/').pop();
                const ext = filename.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                    div.innerHTML = msg.replace(url, `<img src="${url}" style="max-width: 200px; max-height: 200px;">`);
                } else {
                    div.innerHTML = msg.replace(url, `<a href="${url}" download="${filename}" style="color: #00ff00;">${filename}</a>`);
                }
            } else {
                div.innerHTML = msg;
            }
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        document.getElementById('search').addEventListener('input', updateUserLists);

        document.getElementById('back-button').addEventListener('click', switchToPublic);

        document.getElementById('send-button').addEventListener('click', async () => {
            const msg = document.getElementById('message-input').value.trim();
            const fileInput = document.getElementById('file-input');
            let message = msg;
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.url) {
                        message += (msg ? ' ' : '') + 'File: ' + data.url;
                    }
                } catch (error) {
                    alert('Upload failed: ' + error.message);
                    return;
                }
                fileInput.value = '';
            }
            if (message) {
                socket.emit('send_message', { username, message, to: currentChat === 'public' ? null : currentChat });
                document.getElementById('message-input').value = '';
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });

        function loadMessages() {
            const params = new URLSearchParams();
            params.append('username', username);
            if (currentChat !== 'public') {
                params.append('to', currentChat);
            }
            fetch('/messages?' + params)
                .then(res => res.json())
                .then(msgs => {
                    msgs.forEach(msg => {
                        addMessage(`${msg.from}: ${msg.message}`);
                    });
                });
        }

        document.getElementById('logout-button').addEventListener('click', () => {
            socket.emit('leave', { username });
            window.location.href = '/';
        });

        document.getElementById('admin-button').addEventListener('click', () => {
            window.location.href = `/admin.html?username=${username}`;
        });

        document.getElementById('settings-button').addEventListener('click', () => {
            window.location.href = `/settings.html?username=${username}`;
        });
    </script>
</body>
</html>